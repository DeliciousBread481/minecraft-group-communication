<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.SolutionMapper">

    <resultMap id="SolutionResultMap" type="com.github.konstantyn111.crashapi.entity.solution.Solution">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="difficulty" column="difficulty" />
        <result property="version" column="version" />
        <result property="description" column="description" />
        <result property="notes" column="notes" />
        <result property="status" column="status" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />

        <association property="category" javaType="com.example.entity.Category">
            <id property="id" column="category_id" />
        </association>

        <association property="createdBy" javaType="com.example.entity.User">
            <id property="id" column="created_by" />
        </association>

        <association property="reviewedBy" javaType="com.example.entity.User">
            <id property="id" column="reviewed_by" />
        </association>

        <collection property="steps" ofType="com.example.entity.SolutionStep"
                    column="id" select="findStepsBySolutionId"/>

        <collection property="images" ofType="com.example.entity.SolutionImage"
                    column="id" select="findImagesBySolutionId"/>
    </resultMap>

    <!-- 基本CRUD操作 -->
    <insert id="insert">
        INSERT INTO solutions (id, category_id, title, difficulty, version, description, notes, status, created_by, reviewed_by)
        VALUES (#{id}, #{category.id}, #{title}, #{difficulty}, #{version}, #{description},
                #{notes}, #{status}, #{createdBy.id}, #{reviewedBy.id})
    </insert>

    <select id="findById" resultMap="SolutionResultMap">
        SELECT * FROM solutions WHERE id = #{id}
    </select>

    <update id="update">
        UPDATE solutions SET
                             category_id = #{category.id},
                             title = #{title},
                             difficulty = #{difficulty},
                             version = #{version},
                             description = #{description},
                             notes = #{notes},
                             status = #{status},
                             reviewed_by = #{reviewedBy.id},
                             updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

    <delete id="delete">
        DELETE FROM solutions WHERE id = #{id}
    </delete>

    <!-- 关联查询 -->
    <select id="findStepsBySolutionId" resultType="com.example.entity.SolutionStep">
        SELECT * FROM solution_steps
        WHERE solution_id = #{solutionId}
        ORDER BY step_order
    </select>

    <select id="findImagesBySolutionId" resultType="com.example.entity.SolutionImage">
        SELECT * FROM solution_images
        WHERE solution_id = #{solutionId}
        ORDER BY image_order
    </select>

    <!-- 查询方法 -->
    <select id="findByCategoryId" resultMap="SolutionResultMap">
        SELECT * FROM solutions WHERE category_id = #{categoryId}
    </select>

    <select id="findByStatus" resultMap="SolutionResultMap">
        SELECT * FROM solutions WHERE status = #{status}
    </select>
</mapper>